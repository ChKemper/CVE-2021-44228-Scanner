# Log4j2 Vulnerability Scanner

> **INFO**: Version 2.1.1 has to be used due to internal policies 

## What to expect?
* scans recursively through all directories
* Scan contents of JARs, WARs, EARs and ZIPs (also Fat-JARs) by default
* Detects log4j 1.x by default
* -> Get Vulnerability and potentially vulnerability candidates (Existence of JndiLookup.class)
* Report Findings via Syslog

## Changes

### Version 3.0.2
* Updated Hashes for log4j detection
* Scan results could be reported to paid [logpresso Service](https://logpresso.watch/) (optional; only with API key)
  * We don't use it in the internal version ;-)
* Added `--report-patch` option for safe version reporting
* Merges from [logpresso release 3.0.2](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v3.0.2)
* Merges from [logpresso release 3.0.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v3.0.1)
* Merges from [logpresso release 3.0.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v3.0.0)

### Version 2.9.2
* Added MD5 based Log4j version detection. No more N/A.
* Remove Dependency to Quarkus to get cross compiled linux binaries. (See [Build Chapter](#build))
* Improved scan performance (x2.7)
  * Before patch: 340 seconds for 12926 directories and 48569 files
  * After patch: 122 seconds for 12926 directories and 48569 files
* Reduced memory footprint
  * For 5 million files in the single directory, previous version used 1.7GB.
  * Starting with 2.9.0 uses only 0.3GB for same number of files.
* Merges from [logpresso release 2.9.2](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.9.2)
* Merges from [logpresso release 2.9.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.9.1)
* Merges from [logpresso release 2.9.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.9.0)
* Merges from [logpresso release 2.8.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.8.1)
* Merges from [logpresso release 2.8.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.8.0)

### Version 2.7.2
* Merges from [logpresso release 2.7.2](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.7.2)

### Version 2.7.1
* Merges from [logpresso release 2.7.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.7.1)
* Merges from [logpresso release 2.7.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.7.0)
* Merges from [logpresso release 2.6.5](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.6.5)
* Merges from [logpresso release 2.6.4](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.6.4)
* Merges from [logpresso release 2.6.3](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.6.3)
* Merges from [logpresso release 2.6.2](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.6.2)
* Detect also CVE-2021-44832 RCE vulnerability for log4j
  * https://nvd.nist.gov/vuln/detail/CVE-2021-44832
  *  https://logging.apache.org/log4j/2.x/security.html

### Version 2.6.1
* Merges from [logpresso release 2.6.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.6.1)
* Version 2.16.0 is still marked as OK

### Version 2.3.2
* Added CVE-2021-45105 (log4j 2.16.0) detection
* Added --scan-logback option to detect CVE-2021-42550 vulnerability.
* Fix also Log4j1 JAR files with --scan-log4j1 and --fix options.
  * Fixing is always disabled in the atruvia version
* Detect also shaded Log4j 1.x and Log4j 2.x JAR files.
* Support NAR extension. (Apache NiFi archive file)
* Merges from [logpresso release 2.3.2](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.3.2)
* Merges from [logpresso release 2.3.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.3.1)
* Merges from [logpresso release 2.3.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.3.0)
* Merges from [logpresso release 2.2.2](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.2.2)
* Merges from [logpresso release 2.2.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.2.1)
* Merges from [logpresso release 2.2.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.2.0)
* Merges from [logpresso release 2.1.4](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.1.4)
* Merges from [logpresso release 2.1.3](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.1.3)

### Version 2.1.2
* Merges from [logpresso release 2.1.2](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.1.2)
* Fixed infinite junction traversal in PowerShell remoting scenario.
  * e.g. Invoke-Command -ComputerName pcName -ScriptBlock {&C:\log4j2-scan.exe --trace --drives C}

### Version 2.1.1
* Merges from [logpresso release 2.1.1](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.1.1)
* Merges from [logpresso release 2.1.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.1.0)
* All from the previous version
* Native binaries via GraalVM (Windows x64, Linux, macOS)
  * Build upon Quarkus to get easier integration in automatic build tool maven
* The plain java version needs JRE 7 (version 2.0 supports 6.0)
  * Use native binaries to avoid pain with java 7...
* Redefined exit code
  * -1 failed to run
  * 0 for clean (No vulnerability)
  * 1 for found
  * 2 for some errors
  * Use --old-exit-code for legacy automation.
* Ignore network drives for --all-drives on Windows.
* Added --no-empty-report option.


### Version 2.0.0
* Merges from [logpresso release 2.0.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v2.0.0)
* Merges from [logpresso release 1.7.0](https://github.com/logpresso/CVE-2021-44228-Scanner/releases/tag/v1.7.0)
* Support Log4j 1.x CVE-2021-4104 vulnerability scanning using --scan-log4j1 option
  * In the Atruvia version the log4j scanning is activated by default
  * Finally, Atruvias changes are in the logpresso main version
* Special cli parameters for this version (for backward compatibility)
  * "--skip-zip" Do not scan ZIP files
  * "--skip-log4j1" Do not search for log4j 1.x versions
* Version 2.12.2 is still marked as vulnerable
  * Atruvia should use > 2.16.0; Java 7 should not be used ;-)


### Version 1.6.3
* Get latest merges from logpresso (base of this image)
* Version 2.11.1 is still marked as vulnerable; the logpresso version marked this as safe
* Support for printing a report-file
* Bugfix in fixing routing (deactivated in code!)
* **IMPORTANT**: The counting (not the output) has canged: *one jar file should be mapped to only one status. Fat JAR can have both vulnerable and potentially vulnerable files. In this case, I want to return most dangerous status.*
* The scanner exits withexit code > 0 if something was found 

### Version 1.2.11
* Get latest merges from logpresso (base of this image)
* "--silent" Do not print anything until scan is completed.
* Support deep nested JAR and patch for spring boot JAR

### Version 1.2.10
* Support for native applications (build on top of quarkus)
* Get latest merges from logpresso (base of this image)
* Prints the correct CVE's for all vulnerabilities

## Usage
Run the scanner
```
java -jar log4j2-scanner-<version>-atruvia.jar targt_path
```
The target path will be scanned recusivly

or the binaray version
```
./log4j2-scanner-<version>-atruvia-<arc> target_path
```

## Build
The Scanner is build with java and uses maven as build tool.
To build the Scanner you need maven and jdk 7. Creating the JAR is done via 
```
mvn clean package
```

It is also possible to build a native executable (via [GraalVM](https://www.graalvm.org/downloads/)
You need to install GraalVM and additional build tools:
* [Windows](https://www.graalvm.org/docs/getting-started/windows/)
  * [Installation notes](https://medium.com/graalvm/using-graalvm-and-native-image-on-windows-10-9954dc071311)
* [macOS](https://www.graalvm.org/docs/getting-started/macos/)
* [Linux](https://www.graalvm.org/docs/getting-started/linux/)

```
mvn package -Pnative
```
You create a binary depending on the architecture you are running the compile. e.g. running on Windows produces windows binaries.
The atruvia internal versions are created on managed windows and linux computers, the linux version on a virtual machine.

When using docker it is also possible to do a cross compile for linux:
```
./buildNativeImageInDocker.sh
```
The binary is compiled in a docker container ("always" linux) using vegardit/graalvm-maven image. For this the installation of docker (e.g. [Docker Desktop](https://www.docker.com/products/docker-desktop)) is needed.
